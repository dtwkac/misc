name: neovim

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/neovim.yml'

env:
  NEOVIM_VERSION: 0.11.6
  RED: \033[31m
  GREEN: \033[32m
  RESET: \033[0m

jobs:
  imperative-install:
    runs-on: ubuntu-latest
    steps:
      - name: Imperative install
        run: |
          set -e
          avail=$(df -h / | awk 'NR == 2 { print ($4 ~ /T$/ ? 1000 : (sub(/G$/, "", $4) ? int($4) : 0)) }')
          if [ "$avail" -lt 50 ]; then
            echo -e "${RED}Not enough space:${RESET}"
            df -h
            exit 0
          fi
          sudo apt-get update
          sudo apt-get install -y python3-venv npm
          mkdir -p ${HOME}/tools
          cd ${HOME}/tools
          wget -nv https://github.com/neovim/neovim/releases/download/v${NEOVIM_VERSION}/nvim-linux-x86_64.tar.gz
          tar -zxf nvim-linux-x86_64.tar.gz
          rm nvim-linux-x86_64.tar.gz
          echo 'export PATH=$PATH:${HOME}/tools/nvim-linux-x86_64/bin' >> ${HOME}/.bashrc
          git clone https://github.com/LazyVim/starter ${HOME}/.config/nvim
          {
          cat << 'OPTIONS' >> ${HOME}/.config/nvim/lua/config/options.lua

          vim.opt.expandtab = true
          vim.opt.shiftwidth = 4
          vim.opt.relativenumber = false
          vim.opt.guicursor = "a:ver25"
          vim.opt.selection = "exclusive"
          OPTIONS
          }
          {
          cat << 'AUTOCMDS' >> ${HOME}/.config/nvim/lua/config/autocmds.lua

          vim.api.nvim_create_autocmd({ "ColorScheme", "User" }, {
            pattern = { "*", "LazyVimStarted" },
            callback = function()
              vim.api.nvim_set_hl(0, "CursorLineNr", { fg = "NONE", bg = "NONE" })
            end,
          })
          AUTOCMDS
          }
          {
          cat << 'KEYMAPS' >> ${HOME}/.config/nvim/lua/config/keymaps.lua

          vim.keymap.set({'v', 'x'}, '<C-c>', '"+y', { silent = true })
          vim.keymap.set({'n', 'v'}, '<C-v>', '"+p', { silent = true })
          vim.keymap.set('i', '<C-v>', '<C-r>+', { silent = true })
          KEYMAPS
          }
          {
          cat << 'MASON' > ${HOME}/.config/nvim/lua/plugins/mason.lua
          return {
            "mason-org/mason.nvim",
            opts = {
              ensure_installed = {
                "clangd", "clang-format", -- C++
                "pyright", "ruff",        -- Python
              },
            },
          }
          MASON
          }
          {
          cat << 'BLINK' > ${HOME}/.config/nvim/lua/plugins/blink.lua
          return {
            {
              "saghen/blink.cmp",
              opts = {
                completion = {
                  accept = {
                    auto_brackets = { enabled = true },
                  },
                  menu = {
                    draw = {
                      columns = {
                        { "kind_icon", "label", gap = 1 },
                      },
                    },
                  },
                  ghost_text = { enabled = false },
                },
                keymap = {
                  preset = "none",
                  ["<CR>"] = { "fallback" },
                  ["<Tab>"] = { "accept", "fallback" },
                  ["<C-n>"] = { "select_next", "fallback" },
                  ["<C-p>"] = { "select_prev", "fallback" },
                  ["<C-Space>"] = { "show", "fallback" },
                  ["<C-e>"] = { "hide", "fallback" },
                  ["<Up>"] = { "select_prev", "fallback" },
                  ["<Down>"] = { "select_next", "fallback" },
                },
              },
            },
          }
          BLINK
          }
          {
          cat << 'LSP' > ${HOME}/.config/nvim/lua/plugins/lsp.lua
          return {
            {
              "neovim/nvim-lspconfig",
              opts = {
                inlay_hints = { enabled = false },
                servers = {
                  clangd = {
                    cmd = { "clangd", "--function-arg-placeholders=0" },
                  },
                  pyright = {},
                  ruff = {},
                },
              },
            },
          }
          LSP
          }
          ${HOME}/tools/nvim-linux-x86_64/bin/nvim \
            -c "lua require('lazy').sync({wait = true})" \
            -c "lua
              local mr = require('mason-registry')
              local function check()
                for _, p in ipairs(mr.get_all_packages()) do
                  if p:is_installing() then
                    return vim.defer_fn(check, 1000)
                  end
                end
                vim.schedule(function() vim.cmd('qa') end)
              end
              mr.refresh(function()
                local t = {}
                for _, p in ipairs(mr.get_all_packages()) do
                  table.insert(t, p.name)
                  if not p:is_installed() and not p:is_installing() then
                    p:install()
                  end
                end
                table.sort(t)
                local path = vim.fn.getcwd() .. '/all_mason_packages.txt'
                local f = io.open(path, 'w')
                for _, n in ipairs(t) do
                  f:write(n .. '\n')
                end
                f:close()
                check()
              end)"
          echo -e "${GREEN}wc -l all_mason_packages.txt:${RESET}"
          wc -l all_mason_packages.txt
          echo -e "${GREEN}tree -L 1 ${HOME}/.local/share/nvim/mason/packages:${RESET}"
          tree -L 1 ${HOME}/.local/share/nvim/mason/packages
          echo -e "${GREEN}du -sh ${HOME}/.local/share/nvim/mason/packages:${RESET}"
          du -sh ${HOME}/.local/share/nvim/mason/packages

  declarative-install:
    runs-on: ubuntu-latest
    steps:
      - name: Declarative install
        run: |
          set -e
          avail=$(df -h / | awk 'NR == 2 { print ($4 ~ /T$/ ? 1000 : (sub(/G$/, "", $4) ? int($4) : 0)) }')
          if [ "$avail" -lt 50 ]; then
            echo -e "${RED}Not enough space:${RESET}"
            df -h
            exit 0
          fi
          sudo apt-get update
          sudo apt-get install -y python3-venv npm
          mkdir -p ${HOME}/tools
          cd ${HOME}/tools
          wget -nv https://github.com/neovim/neovim/releases/download/v${NEOVIM_VERSION}/nvim-linux-x86_64.tar.gz
          tar -zxf nvim-linux-x86_64.tar.gz
          rm nvim-linux-x86_64.tar.gz
          echo 'export PATH=$PATH:${HOME}/tools/nvim-linux-x86_64/bin' >> ${HOME}/.bashrc
          git clone https://github.com/LazyVim/starter ${HOME}/.config/nvim
          ${HOME}/tools/nvim-linux-x86_64/bin/nvim \
            -c "lua require('lazy').sync({wait = true})" \
            -c "lua
              local r = require('mason-registry')
              r.refresh(function()
                local p = r.get_all_packages()
                local t = {}
                for _, x in ipairs(p) do
                  table.insert(t, x.name)
                end
                table.sort(t)
                local path = vim.fn.getcwd() .. '/all_mason_packages.txt'
                local f = io.open(path, 'w')
                for _, n in ipairs(t) do
                  f:write(n .. '\n')
                end
                f:close()
              end)" \
            -c "qa"
          all_mason_packages=$(awk 'NF { printf "\"%s\",", $0 }' all_mason_packages.txt | sed 's/,$//')
          {
          cat << 'OPTIONS' >> ${HOME}/.config/nvim/lua/config/options.lua

          vim.opt.expandtab = true
          vim.opt.shiftwidth = 4
          vim.opt.relativenumber = false
          vim.opt.guicursor = "a:ver25"
          vim.opt.selection = "exclusive"
          OPTIONS
          }
          {
          cat << 'AUTOCMDS' >> ${HOME}/.config/nvim/lua/config/autocmds.lua

          vim.api.nvim_create_autocmd({ "ColorScheme", "User" }, {
            pattern = { "*", "LazyVimStarted" },
            callback = function()
              vim.api.nvim_set_hl(0, "CursorLineNr", { fg = "NONE", bg = "NONE" })
            end,
          })
          AUTOCMDS
          }
          {
          cat << 'KEYMAPS' >> ${HOME}/.config/nvim/lua/config/keymaps.lua

          vim.keymap.set({'v', 'x'}, '<C-c>', '"+y', { silent = true })
          vim.keymap.set({'n', 'v'}, '<C-v>', '"+p', { silent = true })
          vim.keymap.set('i', '<C-v>', '<C-r>+', { silent = true })
          KEYMAPS
          }
          {
          cat << MASON > ${HOME}/.config/nvim/lua/plugins/mason.lua
          return {
            "mason-org/mason.nvim",
            opts = {
              ensure_installed = {
                ${all_mason_packages}
              },
            },
          }
          MASON
          }
          echo -e "${GREEN}cat ${HOME}/.config/nvim/lua/plugins/mason.lua:${RESET}"
          cat ${HOME}/.config/nvim/lua/plugins/mason.lua
          {
          cat << 'BLINK' > ${HOME}/.config/nvim/lua/plugins/blink.lua
          return {
            {
              "saghen/blink.cmp",
              opts = {
                completion = {
                  accept = {
                    auto_brackets = { enabled = true },
                  },
                  menu = {
                    draw = {
                      columns = {
                        { "kind_icon", "label", gap = 1 },
                      },
                    },
                  },
                  ghost_text = { enabled = false },
                },
                keymap = {
                  preset = "none",
                  ["<CR>"] = { "fallback" },
                  ["<Tab>"] = { "accept", "fallback" },
                  ["<C-n>"] = { "select_next", "fallback" },
                  ["<C-p>"] = { "select_prev", "fallback" },
                  ["<C-Space>"] = { "show", "fallback" },
                  ["<C-e>"] = { "hide", "fallback" },
                  ["<Up>"] = { "select_prev", "fallback" },
                  ["<Down>"] = { "select_next", "fallback" },
                },
              },
            },
          }
          BLINK
          }
          {
          cat << 'LSP' > ${HOME}/.config/nvim/lua/plugins/lsp.lua
          return {
            {
              "neovim/nvim-lspconfig",
              opts = {
                inlay_hints = { enabled = false },
                servers = {
                  clangd = {
                    cmd = { "clangd", "--function-arg-placeholders=0" },
                  },
                  pyright = {},
                  ruff = {},
                },
              },
            },
          }
          LSP
          }
          ${HOME}/tools/nvim-linux-x86_64/bin/nvim \
            -c "lua require('lazy').sync({wait = true})" \
            -c "lua
              local mr = require('mason-registry')
              local function check()
                for _, p in ipairs(mr.get_all_packages()) do
                  if p:is_installing() then
                    return vim.defer_fn(check, 1000)
                  end
                end
                vim.schedule(function() vim.cmd('qa') end)
              end
              mr.refresh(check)"
          echo -e "${GREEN}wc -l all_mason_packages.txt:${RESET}"
          wc -l all_mason_packages.txt
          echo -e "${GREEN}tree -L 1 ${HOME}/.local/share/nvim/mason/packages:${RESET}"
          tree -L 1 ${HOME}/.local/share/nvim/mason/packages
          echo -e "${GREEN}du -sh ${HOME}/.local/share/nvim/mason/packages:${RESET}"
          du -sh ${HOME}/.local/share/nvim/mason/packages
